# SYST 568 Project
# Data Cleaning. Created by Chad Scott. Last updated 11/29/2020
options(max.print = 10000)
# Install Lahman package
#  install.packages("Lahman")
# load libraries
library(Lahman)
library(data.table)
library(dplyr)
# view all available data sets in the Lahman package
data( package = "Lahman")
# load in Teams data
data("Teams")
Teams <- data.table(Teams)
# explore Teams data
str(Teams)
head(Teams)
# filter Teams to only include 1960 - 2019
Teams <- Teams[yearID>1968,]
summary(Teams)
head(Teams)
### Playoffs Variable ##########################################################################
# Teams that made the playoffs
#2012 - Present (not inlcuding 2020) 10 teams made the playoffs
Teams[yearID==2019,]
Teams[yearID==2019 & (DivWin=="Y" | WCWin == "Y"),]
Teams[yearID==2012 & (DivWin=="Y" | WCWin == "Y"),1:40]
# 1994 -2011 8 teams made the playoffs 1994 there was NO POST SEASON
Teams[yearID==2011,1:40]
Teams[yearID==2011 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1995,1:40]
Teams[yearID==1995 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1994,]
Teams[yearID==1994 & (DivWin=="Y" | WCWin=="Y"),1:40]
# 1969 -1993 4 teams made the playoffs
Teams[yearID==1993,]
Teams[yearID==1993 & DivWin=="Y",]
Teams[yearID==1969,1:40]
Teams[yearID==1969 & DivWin=="Y",1:40]
# Creating playoffs variable
Teams$Playoffs <- "N"
Teams[yearID>1993 & (DivWin=="Y" | WCWin=="Y"), Playoffs:= "Y"]
Teams[yearID<1994 & DivWin=="Y", Playoffs:="Y"]
# creating playoffs Lag variable
setkey(Teams, teamID, yearID) # important for ordering
Teams[,playoff_prevyear:=(shift(Playoffs, 1)),by=teamID]
Teams[teamID=='ATL',c(1:20,46:51)]
#### Team Salaries ################################################################################
data("Salaries")
Salaries <- data.table(Salaries)
str(Salaries)
head(Salaries)
Salaries[,TeamSalary:=sum(salary), by = c("yearID","teamID")]
Salaries <- unique(Salaries[,c("yearID","teamID","TeamSalary")])
# merge Salries with Teams data
Teams <- merge(Teams, Salaries,  by = c("yearID","teamID"), all.x = TRUE)
Teams
# SYST 568 Project
# Data Cleaning. Created by Chad Scott. Last updated 12/01/2020 by Jonathan Nelson.
options(max.print = 10000)
# Install Lahman package
#  install.packages("Lahman")
# load libraries
library(Lahman)
library(data.table)
library(dplyr)
# view all available data sets in the Lahman package
#data( package = "Lahman")
# load in Teams data
data("Teams")
Teams <- data.table(Teams)
# explore Teams data
str(Teams)
head(Teams)
# filter Teams to only include 1960 - 2019
Teams <- Teams[yearID>1968,]
summary(Teams)
head(Teams)
### Playoffs Variable ########################################################
# Teams that made the playoffs
#2012 - Present (not inlcuding 2020) 10 teams made the playoffs
Teams[yearID==2019,]
Teams[yearID==2019 & (DivWin=="Y" | WCWin == "Y"),]
Teams[yearID==2012 & (DivWin=="Y" | WCWin == "Y"),1:40]
# 1994 -2011 8 teams made the playoffs 1994 there was NO POST SEASON
Teams[yearID==2011,1:40]
Teams[yearID==2011 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1995,1:40]
Teams[yearID==1995 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1994,]
Teams[yearID==1994 & (DivWin=="Y" | WCWin=="Y"),1:40]
# 1969 -1993 4 teams made the playoffs
Teams[yearID==1993,]
Teams[yearID==1993 & DivWin=="Y",]
Teams[yearID==1969,1:40]
Teams[yearID==1969 & DivWin=="Y",1:40]
# Creating playoffs variable
Teams$Playoffs <- "N"
Teams[yearID>1993 & (DivWin=="Y" | WCWin=="Y"), Playoffs:= "Y"]
Teams[yearID<1994 & DivWin=="Y", Playoffs:="Y"]
# creating playoffs Lag variable
setkey(Teams, teamID, yearID) # important for ordering
Teams[,playoff_nextyear:=(shift(Playoffs, -1)),by=teamID]
Teams[teamID=='ATL',c(1:20,46:50)]
### Team Salaries ############################################################
data("Salaries")
Salaries <- data.table(Salaries)
str(Salaries)
head(Salaries)
Salaries$salary <- as.numeric(Salaries$salary)
Salaries[,TeamSalary:=sum(salary), by = c("yearID","teamID")]
Salaries <- unique(Salaries[,c("yearID","teamID","TeamSalary")])
Salaries[,TeamSalary:=TeamSalary/mean(TeamSalary), by = c("yearID")]
Salaries
# merge Salaries with Teams data
Teams_w_salary <- merge(Teams, Salaries,  by = c("yearID","teamID"), all.x = TRUE)
# filter to only years with team salary data
Teams_w_salary <- Teams_w_salary[yearID>1984 & yearID<2017,]
### Features for modeling ##########################################
### Data without salary ###
final_teams <- Teams[,c(1,6,15,17:24,28,33:36,50)]
### Data with salary ###
final_teams_salary <- Teams_w_salary[,c(1,6,15,17:24,28,33:36,50,51)]
# write out to csv
dir.create('data', showWarning=FALSE)
write.csv(final_teams, file.path('data', 'final_teams.csv'))
write.csv(final_teams_salary, file.path('data', 'final_teams_salary.csv'))
library(ggplot2)
library(ROCR)
library(randomForest)
library(caret)
library(dplyr)
final_teams_salary = read.csv('./data/final_teams_salary.csv')
factor_cols = c('playoff_nextyear')
final_teams_salary[factor_cols] <- lapply(final_teams_salary[factor_cols] , factor)
final_teams_salary <- na.omit(final_teams_salary, cols="playoff_nextyear")
# train-test split by yearID
set.seed(12345)
years <- unique(final_teams_salary$yearID)
train_years <- sample(years, 0.5*length(years))
test_years <- setdiff(years, train_years)
train <- subset(final_teams_salary, yearID %in% train_years)
test <- subset(final_teams_salary, yearID %in% test_years)
outputs <- data.frame(model_name=character(),
accuracy=numeric(),
precision=numeric(),
recall=numeric(),
f1score=numeric())
get_top8_predictions <- function(data, model) {
data$playoff_prob = predict(model, data, type="prob")[,2]
playoff_teams <- data %>%
group_by(yearID) %>%
slice_max(playoff_prob, n = 8, with_ties = FALSE)
playoff_teams$playoff_pred = 'Y'
pred <- merge(test, playoff_teams, all.x=TRUE)
pred$playoff_pred[is.na(pred$playoff_pred)] <- 'N'
return(pred$playoff_pred)
}
record_outputs <- function(model_name, pred, model) {
ConMatrix = table(test$playoff_nextyear, pred)
# calculate metrics
accuracy = (ConMatrix[1, 1] + ConMatrix[2, 2]) /  sum(ConMatrix)
precision = ConMatrix[2, 2] / (ConMatrix[2, 2] + ConMatrix[1, 2])
recall = ConMatrix[2, 2] / (ConMatrix[2, 2] + ConMatrix[2, 1])
f1score = 2*(precision*recall / (precision+recall))
return(list(model_name, accuracy, precision, recall, f1score))
}
tc <- trainControl(method = "repeatedCV", number=2, repeats=1)
logit.model <- train(playoff_nextyear~., data=train, method="LogitBoost", trControl=tc)
logit_pred <- get_top8_predictions(test, logit.model)
outputs[1,] <- record_outputs('Logit Regression', logit_pred, logit.model)
logit_pred
outputs
tc <- trainControl(method = "repeatedCV", number=2, repeats=1)
rf.model <- train(playoff_nextyear~., data=train, method="rf", trControl=tc)
rf_pred <- get_top8_predictions(test, rf.model)
outputs[2,] <- record_outputs('Random Forest', rf_pred, rf.model)
tc <- trainControl(method = "repeatedCV", number=2, repeats=1)
xgb.model <- train(playoff_nextyear~., data=train, method="xgbTree", trControl=tc)
xgb_pred <- get_top8_predictions(test, xgb.model)
outputs[3,] <- record_outputs('XGB', xgb_pred, rf.model)
print(outputs)
xgb.model
summary(xgb.model)
print(outputs)
logit.model
summary(logit.model)
train
final_teams_salary
options(max.print = 1000)
final_teams_salary
Teams_w_salary
# exploritory analysis
library(ggplot2)
Teams_w_salary
ggplot(Teams_w_salary, aes(W,playoff_nextyear)) +
geom_point()
ggplot(Teams_w_salary, aes(W,playoff_nextyear)) +
geom_bar()
ggplot(Teams_w_salary, aes(W,playoff_nextyear)) +
geom_histogram()
ggplot(Teams_w_salary, aes(x=W,y=playoff_nextyear)) +
geom_histogram()
ggplot(Teams_w_salary, aes(x=W,y=playoff_nextyear)) +
geom_boxplot()
ggplot(Teams_w_salary, aes(x=playoff_nextyear,y=W)) +
geom_boxplot()
Teams_w_salary[yearID==2016,]
ggplot(Teams_w_salary, aes(x=playoff_nextyear,y=H)) +
geom_boxplot()
str(Teams_w_salary)
# load libraries
library(Lahman)
library(data.table)
library(dplyr)
# load in Teams data
data("Teams")
Teams <- data.table(Teams)
# explore Teams data
str(Teams)
head(Teams)
# filter Teams to only include 1960 - 2019
Teams <- Teams[yearID>1968,]
summary(Teams)
head(Teams)
### Playoffs Variable ########################################################
# Teams that made the playoffs
#2012 - Present (not inlcuding 2020) 10 teams made the playoffs
Teams[yearID==2019,]
Teams[yearID==2019 & (DivWin=="Y" | WCWin == "Y"),]
Teams[yearID==2012 & (DivWin=="Y" | WCWin == "Y"),1:40]
# 1994 -2011 8 teams made the playoffs 1994 there was NO POST SEASON
Teams[yearID==2011,1:40]
Teams[yearID==2011 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1995,1:40]
Teams[yearID==1995 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1994,]
Teams[yearID==1994 & (DivWin=="Y" | WCWin=="Y"),1:40]
# 1969 -1993 4 teams made the playoffs
Teams[yearID==1993,]
Teams[yearID==1993 & DivWin=="Y",]
Teams[yearID==1969,1:40]
Teams[yearID==1969 & DivWin=="Y",1:40]
# Creating playoffs variable
Teams$Playoffs <- "N"
Teams[yearID>1993 & (DivWin=="Y" | WCWin=="Y"), Playoffs:= "Y"]
Teams[yearID<1994 & DivWin=="Y", Playoffs:="Y"]
# creating playoffs Lag variable
setkey(Teams, teamID, yearID) # important for ordering
Teams[,playoff_nextyear:=(shift(Playoffs, -1)),by=teamID]
Teams[teamID=='ATL',c(1:20,46:50)]
### Team Salaries ############################################################
data("Salaries")
Salaries <- data.table(Salaries)
str(Salaries)
head(Salaries)
Salaries$salary <- as.numeric(Salaries$salary)
Salaries[,TeamSalary:=sum(salary), by = c("yearID","teamID")]
Salaries <- unique(Salaries[,c("yearID","teamID","TeamSalary")])
Salaries[,TeamSalary:=TeamSalary/mean(TeamSalary), by = c("yearID")]
Salaries
# merge Salaries with Teams data
Teams_w_salary <- merge(Teams, Salaries,  by = c("yearID","teamID"), all.x = TRUE)
# filter to only years with team salary data
Teams_w_salary <- Teams_w_salary[yearID>1984 & yearID<2017 & yearID!=1993,]
Teams_w_salary
# add 2017 - 2019 salaries
Sal_17_19 <- read.csv('../data/input/salaries2017-19.csv')
Sal_17_19
Salaries
Salaries
# add 2017 - 2019 salaries
Sal_17_19 <- read.csv('../data/input/salaries2017-19.csv')
Sal_17_19
Salaries1 <- rbind(Salaries,Sal_17_19)
setnames(Sal_17_19, "salary","TeamSalary")
Salaries1 <- rbind(Salaries,Sal_17_19)
Salaries1
# load libraries
library(Lahman)
library(data.table)
library(dplyr)
# load in Teams data
data("Teams")
Teams <- data.table(Teams)
# explore Teams data
str(Teams)
head(Teams)
# filter Teams to only include 1960 - 2019
Teams <- Teams[yearID>1968,]
summary(Teams)
head(Teams)
### Playoffs Variable ########################################################
# Teams that made the playoffs
#2012 - Present (not inlcuding 2020) 10 teams made the playoffs
Teams[yearID==2019,]
Teams[yearID==2019 & (DivWin=="Y" | WCWin == "Y"),]
Teams[yearID==2012 & (DivWin=="Y" | WCWin == "Y"),1:40]
# 1994 -2011 8 teams made the playoffs 1994 there was NO POST SEASON
Teams[yearID==2011,1:40]
Teams[yearID==2011 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1995,1:40]
Teams[yearID==1995 & (DivWin=="Y" | WCWin=="Y"),1:40]
Teams[yearID==1994,]
Teams[yearID==1994 & (DivWin=="Y" | WCWin=="Y"),1:40]
# 1969 -1993 4 teams made the playoffs
Teams[yearID==1993,]
Teams[yearID==1993 & DivWin=="Y",]
Teams[yearID==1969,1:40]
Teams[yearID==1969 & DivWin=="Y",1:40]
# Creating playoffs variable
Teams$Playoffs <- "N"
Teams[yearID>1993 & (DivWin=="Y" | WCWin=="Y"), Playoffs:= "Y"]
Teams[yearID<1994 & DivWin=="Y", Playoffs:="Y"]
# creating playoffs Lag variable
setkey(Teams, teamID, yearID) # important for ordering
Teams[,playoff_nextyear:=(shift(Playoffs, -1)),by=teamID]
Teams[teamID=='ATL',c(1:20,46:50)]
### Team Salaries ############################################################
data("Salaries")
Salaries <- data.table(Salaries)
str(Salaries)
head(Salaries)
Salaries$salary <- as.numeric(Salaries$salary)
Salaries[,TeamSalary:=sum(salary), by = c("yearID","teamID")]
Salaries <- unique(Salaries[,c("yearID","teamID","TeamSalary")])
Salaries[,TeamSalary:=TeamSalary/mean(TeamSalary), by = c("yearID")]
Salaries
# add 2017 - 2019 salaries
Sal_17_19 <- read.csv('../data/input/salaries2017-19.csv')
setnames(Sal_17_19, "salary","TeamSalary")
Salaries <- rbind(Salaries,Sal_17_19)
# merge Salaries with Teams data
Teams_w_salary <- merge(Teams, Salaries,  by = c("yearID","teamID"), all.x = TRUE)
# filter to only years with team salary data
Teams_w_salary <- Teams_w_salary[yearID>1984 & yearID<2017 & yearID!=1993,]
### Data without salary ###
final_teams <- Teams[,c(1,6,15,17:24,28,33:36,50)]
### Data with salary ###
final_teams_salary <- Teams_w_salary[,c(1,6,15,17:24,28,33:36,50,51)]
# write out to csv
dir.create('data', showWarning=FALSE)
write.csv(final_teams, file.path('data', 'final_teams.csv'))
write.csv(final_teams_salary, file.path('data', 'final_teams_salary.csv'))
library(ggplot2)
library(ROCR)
library(randomForest)
library(caret)
library(dplyr)
final_teams_salary = read.csv('./data/final_teams_salary.csv')[,-1]
factor_cols = c('playoff_nextyear')
final_teams_salary[factor_cols] <- lapply(final_teams_salary[factor_cols] , factor)
final_teams_salary <- na.omit(final_teams_salary, cols="playoff_nextyear")
# get number of playoff teams per year
playoffs_year <- final_teams_salary %>%
group_by(yearID) %>%
count(playoff_nextyear) %>%
filter(playoff_nextyear == 'Y')
playoffs_year <- playoffs_year[,c(1,3)]
# train-test split by yearID
set.seed(12345)
years <- unique(final_teams_salary$yearID)
train_years <- sample(years, 0.5*length(years))
test_years <- setdiff(years, train_years)
train <- subset(final_teams_salary, yearID %in% train_years)
test <- subset(final_teams_salary, yearID %in% test_years)
outputs <- data.frame(model_name=character(),
accuracy=numeric(),
precision=numeric(),
recall=numeric(),
f1score=numeric())
# NOTE: this does not work yet
get_division_predictions <- function(data, model) {
data$playoff_prob = predict(logit.model, data, type="response")
playoff_teams <- data %>%
group_by(yearID,lgID,divID) %>%
slice_max(playoff_prob, n = 1, with_ties = FALSE)
playoff_teams$playoff_pred = 'Y'
pred <- merge(test, playoff_teams, all.x=TRUE)
pred$playoff_pred[is.na(pred$playoff_pred)] <- 'N'
return(pred$playoff_pred)
}
get_top_predictions <- function(data, model) {
total_pred = vector()
for (year in unique(data$yearID)) {
year_data = filter(data,  yearID==year)
year_data$playoff_prob = predict(logit.model, year_data, type="response")
playoffs_n <- filter(playoffs_year, yearID==year)$n
playoff_teams <- year_data %>%
slice_max(playoff_prob, n = playoffs_n, with_ties = FALSE)
playoff_teams$playoff_pred = 'Y'
pred <- merge(year_data, playoff_teams, all.x=TRUE)
pred$playoff_pred[is.na(pred$playoff_pred)] <- 'N'
total_pred = append(total_pred, pred$playoff_pred)
}
return(total_pred)
}
record_outputs <- function(model_name, pred, model) {
ConMatrix = table(test$playoff_nextyear, pred)
# calculate metrics
accuracy = (ConMatrix[1, 1] + ConMatrix[2, 2]) /  sum(ConMatrix)
precision = ConMatrix[2, 2] / (ConMatrix[2, 2] + ConMatrix[1, 2])
recall = ConMatrix[2, 2] / (ConMatrix[2, 2] + ConMatrix[2, 1])
f1score = 2*(precision*recall / (precision+recall))
return(list(model_name, accuracy, precision, recall, f1score))
}
tc <- trainControl(method = "repeatedCV", number=2, repeats=1)
logit.model <- train(playoff_nextyear~., data=train, method="LogitBoost", trControl=tc)
logit_pred <- get_top_predictions(test, logit.model)
str(final_teams_salary)
